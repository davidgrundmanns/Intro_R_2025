---
title: "Intro to R: Session 2 - Solutions"
output:
  html_notebook:
    toc: TRUE
    toc_level: 3
    code_folding: "none"
editor_options: 
  markdown: 
    wrap: sentence
---

#### Loading all necessary data, packages and objects for Session 2 exercises

```{r}
#======================Exercise 2===========================#
p_needed <-
  c("tidyverse", "gapminder", "WDI", "haven",
               "psych", "ineq","corrplot", "skimr")

packages <- rownames(installed.packages())

p_to_install <- p_needed[!(p_needed %in% packages)]

if (length(p_to_install) > 0) {
  install.packages(p_to_install)
}

sapply(p_needed, require, character.only = TRUE)


d1 <- read.csv("data/ESS10_sub.csv")
countries <- c("HU", "FR", "DE", "US")
indicators = c("NY.GDP.PCAP.CD", "TX.VAL.FUEL.ZS.UN", "EN.ATM.CO2E.KT")
wb <- WDI( 
  country = countries, #We include our countries 
  indicator = indicators, #We include our variables 
  start = 1960, #start date 
  end = 2023) #end date 
#============================================================#

```

### Exercise 1: You are interested in discrimination and the perception of the judicative. More specifically, you want to know if people, who fell discriminated evaluate courts differently. Below you see a table with all variables you want to include in your analysis: 

| **Variable**  | **Description**                                 |
|---------------|-------------------------------------------------|
| **cntry**     | Country of respondent                           |
| **dscrgrp**   | Member of group discriminated against in country|
| **cttresa**   | The courts treat everyone the same              |
| **agea**      | Age                                             |
| **gndr**      | Gender                                          |
| **eisced**    | Highest level of education                      |
| **lrscale**   | Left_Right Placement                            |
|---------------|-------------------------------------------------|

a. Wrangle the data, and assign it to an object called **ess**. 
b. Select the variables you need
c. Filter for Austria, Belgium, Denmark, Georgia, Iceland and the Russian Federation 
d. Have a look at the codebook and code all irrelevant values as missing. If you have binary variables recode them from 1, 2 to 0 to 1  
e. You want to build an extremism variable: You do so by subtracting 5 from the from the variable and squaring it afterwards. Call it extremism 
f. Rename the variables to more intuitive names, don't forget to name binary varaibles after the category which is on 1
g. drop all missing values 
h. Check out your new dataset 

```{r}

ess <- d1 %>% 
  select(cntry, dscrgrp, cttresa, agea, gndr, eisced, lrscale) %>% #a
  filter(cntry %in% c("AT", "BE", "DK", "GE", "IS","RU")) %>% #b
  mutate(dscrgrp = case_when( #c
    dscrgrp == 1 ~ 0, 
    dscrgrp == 2 ~ 1,
    dscrgrp %in% c(7, 8, 9) ~ NA_real_, 
    TRUE ~ dscrgrp),
    cttresa = case_when( 
    cttresa %in% c(77, 88, 99) ~ NA_real_, 
    TRUE ~ cttresa),
    agea = case_when(
    agea == 999 ~ NA_real_, 
    TRUE ~ agea),
    gndr = case_when(
      gndr == 1 ~ 0, 
      gndr == 2 ~ 1,
      gndr == 9 ~ NA_real_
    ),
    eisced = case_when( 
      eisced %in% c(55, 77, 88, 99) ~ NA_real_,
      TRUE ~ eisced),
    lrscale = case_when(
      lrscale %in% c(77, 88, 99) ~ NA_real_,
      TRUE ~ lrscale), 
    extremism = (lrscale - 5)^2 #d, you could do this step also in a separate mutate function if you think that is more intuitive 
  ) %>% 
  rename(discriminated = dscrgrp,  
         court = cttresa,
         age = agea, 
         female = gndr, 
         education = eisced, 
         lrscale = lrscale, 
         extremism = extremism
         ) %>% 
  drop_na()

#Checking the dataset 

head(ess)

  
```


### Exercise 2: Merging Datasets 

The `gapminder` package in R loads automatically the gapminder dataset. gapminder is an independent educational non-profit fighting global misconceptions, check out their website: https://www.gapminder.org/
The gapminder dataset is already loaded. 

#### a. Get an overview of the gapminder dataset. There are different ways to do so, you can choose by yourself

```{r}

head(gapminder)#my favourite

glimpse(gapminder) #dplyr function

skimr::skim_without_charts(gapminder) #some descriptives 

```

#### b. We already loaded World Bank Data in the object **wb**. Merge the two datasets! Use `left_join()` from `tidyverse` or `merge()` with `all.x = TRUE` in base R syntax to merge the gapminder dataset into the World Bank data. Define a new object called `df_mer`.

```{r}

head(wb)

#With pipeline 

df_mer <- wb %>% 
  left_join(gapminder, by = c( 
            "country" = "country",
            "year" = "year"))

#without pipeline 

# df_mer <- left_join(wb, gapminder, by = c("country" = "country", "year" = "year") 


# with base R
# df_mer <- merge(wb, gapminder, by = c("country" = "country", "year" = "year"), all.x = TRUE)



```
